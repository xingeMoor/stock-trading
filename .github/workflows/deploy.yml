name: Deploy to Aliyun

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_KEY }}
          log-public-key: false
      
      - name: Add host to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 47.253.133.165 >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Deploy to Aliyun Server
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER || 'root' }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST || '47.253.133.165' }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/opt/qbrain' }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
          
          # æ‰§è¡Œè¿œç¨‹éƒ¨ç½²å‘½ä»¤
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            $DEPLOY_USER@$DEPLOY_HOST << 'REMOTE_SCRIPT'
            
            set -e
            echo "ğŸ“¦ è¿æ¥åˆ°æœåŠ¡å™¨æˆåŠŸ"
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/qbrain || {
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
              sudo mkdir -p /opt/qbrain
              sudo chown $(whoami):$(whoami) /opt/qbrain
              cd /opt/qbrain
            }
            
            # å¦‚æœæ˜¯é¦–æ¬¡éƒ¨ç½²ï¼Œå…‹éš†ä»“åº“
            if [ ! -d .git ]; then
              echo "ğŸ”„ é¦–æ¬¡éƒ¨ç½²ï¼Œå…‹éš†ä»£ç åº“..."
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            echo "ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/$(echo ${{ github.ref }} | sed 's/refs\/heads\///')
            
            echo "ğŸ“‹ å½“å‰ç‰ˆæœ¬: $(git rev-parse --short HEAD)"
            echo "ğŸ‘¤ æäº¤è€…: $(git log -1 --pretty=format:'%an')"
            echo "ğŸ’¬ æäº¤ä¿¡æ¯: $(git log -1 --pretty=format:'%s')"
            
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            echo "ğŸ” è®¾ç½®æ–‡ä»¶æƒé™..."
            chmod +x scripts/*.sh 2>/dev/null || true
            
            # æ‰§è¡Œæœ¬åœ°éƒ¨ç½²è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f scripts/deploy-local.sh ]; then
              echo "ğŸ”§ æ‰§è¡Œæœ¬åœ°éƒ¨ç½²è„šæœ¬..."
              bash scripts/deploy-local.sh
            else
              echo "ğŸ”§ æ‰§è¡Œæ ‡å‡†éƒ¨ç½²æµç¨‹..."
              
              # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
              if [ ! -d venv ]; then
                echo "ğŸ“¦ åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ..."
                python3 -m venv venv
              fi
              
              # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
              echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–..."
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
              
              # æ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœæœ‰ï¼‰
              if [ -f manage.py ]; then
                echo "ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
                python manage.py migrate || true
              fi
              
              # æ”¶é›†é™æ€æ–‡ä»¶ï¼ˆå¦‚æœæ˜¯Djangoï¼‰
              if [ -f manage.py ] && python -c "import django" 2>/dev/null; then
                echo "ğŸ“ æ”¶é›†é™æ€æ–‡ä»¶..."
                python manage.py collectstatic --noinput || true
              fi
              
              # é‡å¯æœåŠ¡
              echo "ğŸ”„ é‡å¯æœåŠ¡..."
              sudo systemctl restart qbrain-api 2>/dev/null || true
              sudo systemctl restart qbrain-worker 2>/dev/null || true
              sudo systemctl restart qbrain-scheduler 2>/dev/null || true
              
              # æ£€æŸ¥æœåŠ¡çŠ¶æ€
              echo "âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
              sudo systemctl is-active qbrain-api 2>/dev/null && echo "âœ“ APIæœåŠ¡è¿è¡Œæ­£å¸¸" || echo "âš ï¸ APIæœåŠ¡æœªè¿è¡Œ"
              sudo systemctl is-active qbrain-worker 2>/dev/null && echo "âœ“ WorkeræœåŠ¡è¿è¡Œæ­£å¸¸" || echo "âš ï¸ WorkeræœåŠ¡æœªè¿è¡Œ"
            fi
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "â° éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          REMOTE_SCRIPT
          
          echo "âœ… éƒ¨ç½²æµç¨‹æ‰§è¡Œå®Œæ¯•"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
