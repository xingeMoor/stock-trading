# 交易执行系统设计文档

## 1. 系统概述

交易执行系统是 Q 脑量化交易平台的核心组件，负责将策略层产生的交易信号转化为实际的市场订单。系统设计遵循**低延迟、高可靠、强风控**的原则。

### 1.1 核心目标
- **信号处理**: 高效接收、验证、排序和去重交易信号
- **智能执行**: 通过最优路径执行订单，最小化市场冲击和滑点
- **风险控制**: 多层风控检查，防止异常交易和超限操作
- **执行监控**: 实时跟踪订单状态，分析执行质量

### 1.2 系统架构

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  策略层 (Strategy) │ ──▶ │  信号管理系统    │ ──▶ │  订单执行引擎    │
│                 │     │  SignalManager   │     │  OrderExecutor   │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                                                        │
                                                        ▼
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  交易所/券商 API  │ ◀──▶│  执行监控系统    │ ◀──│  风控检查模块    │
│  (Broker/Exchange)│     │ExecutionMonitor  │     │  RiskChecker     │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

## 2. 信号管理系统 (SignalManager)

### 2.1 信号生命周期

```
生成 → 接收 → 验证 → 优先级排序 → 去重/合并 → 待执行队列
```

### 2.2 信号类型

| 类型 | 优先级 | 描述 |
|------|--------|------|
| `EMERGENCY_CLOSE` | 1 (最高) | 紧急平仓信号 (风控触发) |
| `STOP_LOSS` | 2 | 止损信号 |
| `TAKE_PROFIT` | 3 | 止盈信号 |
| `STRATEGY_ENTRY` | 4 | 策略开仓信号 |
| `STRATEGY_EXIT` | 5 | 策略平仓信号 |
| `REBALANCE` | 6 (最低) | 组合再平衡信号 |

### 2.3 信号验证规则

1. **格式验证**: 必需字段 (symbol, side, quantity, price_type)
2. **逻辑验证**: 数量 > 0, 价格合理性检查
3. **时效验证**: 信号过期时间检查
4. **权限验证**: 交易标的在允许列表中

### 2.4 去重策略

- **时间窗口去重**: 同一标的在 N 秒内的相同方向信号合并
- **数量合并**: 同方向信号累加数量，反方向信号抵消
- **价格更新**: 保留最新价格或最优价格

## 3. 订单执行引擎 (OrderExecutor)

### 3.1 执行流程

```
接收信号 → 风控检查 → 订单路由 → 拆单算法 → 下单 → 确认
```

### 3.2 智能订单路由 (SOR)

**路由优先级**:
1. 价格最优 (考虑买卖价差)
2. 流动性充足 (避免大单冲击)
3. 执行速度快 (低延迟通道)
4. 费用最低 (佣金 + 滑点)

**支持的市场**:
- 美股：NASDAQ, NYSE, ARCA
- A 股：上交所，深交所

### 3.3 拆单算法

#### TWAP (时间加权平均价格)
```python
# 将大单均匀拆分到指定时间段
total_quantity = 10000
duration_minutes = 60
slice_count = 12  # 每 5 分钟执行一次
slice_quantity = total_quantity / slice_count  # 833 股/次
```

**适用场景**: 流动性一般的股票，希望减少市场冲击

#### VWAP (成交量加权平均价格)
```python
# 根据历史成交量分布调整每单大小
# 在成交量大的时段多执行，成交量小的时段少执行
volume_profile = get_volume_profile(symbol)  # 获取历史成交量分布
slice_quantity = total_quantity * (period_volume / total_volume)
```

**适用场景**: 流动性好的股票，跟踪市场平均成交价

#### 执行参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `max_slice_pct` | 5% | 单笔最大占日均成交量比例 |
| `min_slice_interval` | 30s | 最小下单间隔 |
| `price_tolerance` | 0.5% | 价格偏离容忍度 |
| `urgency_factor` | 1.0 | 紧急程度 (1-10) |

### 3.4 滑点控制

**滑点预算**:
```
滑点预算 (bps) = base_slippage + volatility_adjustment + urgency_adjustment

base_slippage = 5 bps (基础滑点)
volatility_adjustment = ATR / price * 100 * 0.5 (波动率调整)
urgency_adjustment = (urgency_level - 5) * 2 bps (紧急程度调整)
```

**控制措施**:
- 设置限价单价格保护
- 实时监控市场深度
- 动态调整下单节奏
- 超过滑点预算时暂停执行

## 4. 风控检查模块 (RiskChecker)

### 4.1 前置风控检查

**检查顺序**:
1. 交易权限检查 (标的是否可交易)
2. 黑名单检查 (标的是否在黑名单)
3. 仓位限制检查 (是否超限)
4. 资金充足检查 (购买力是否足够)
5. 集中度检查 (单一标的占比)
6. 日交易次数检查 (Pattern Day Trader 规则)

### 4.2 仓位限制

| 限制类型 | 默认值 | 说明 |
|----------|--------|------|
| 单标的最大仓位 | 20% | 单一股票不超过总资产 20% |
| 单行业最大仓位 | 40% | 单一行业不超过总资产 40% |
| 最大总仓位 | 95% | 保留 5% 现金应对赎回 |
| 单标的日交易上限 | 5 次 | 避免 PDT 限制 (美股) |
| 最大杠杆倍数 | 2x | 融资杠杆限制 |

### 4.3 黑名单管理

**黑名单类型**:
- **永久黑名单**: ST 股票、退市股票、问题公司
- **临时黑名单**: 停牌股票、流动性枯竭股票
- **策略黑名单**: 特定策略不交易的标的

**更新机制**: 每日盘前更新，支持实时添加

### 4.4 风控响应

| 违规类型 | 响应措施 |
|----------|----------|
| 轻度违规 (接近限制) | 警告，允许执行但记录 |
| 中度违规 (超出限制 10% 内) | 拒绝执行，通知策略层调整 |
| 严重违规 (超出限制 10% 以上) | 拒绝执行，触发风控警报，暂停相关策略 |

## 5. 执行监控系统 (ExecutionMonitor)

### 5.1 成交回报处理

**回报类型**:
- `FILLED`: 完全成交
- `PARTIALLY_FILLED`: 部分成交
- `CANCELLED`: 订单取消
- `REJECTED`: 订单拒绝
- `EXPIRED`: 订单过期

**处理流程**:
```
接收回报 → 解析 → 更新订单状态 → 更新仓位 → 记录日志 → 通知策略层
```

### 5.2 异常订单处理

**异常类型**:
1. **延迟成交**: 超过预期时间未成交
2. **部分成交**: 长时间停留在部分成交状态
3. **价格异常**: 成交价偏离市场价过大
4. **重复成交**: 同一订单多次成交
5. **API 错误**: 券商 API 返回错误

**处理策略**:
```python
异常处理矩阵:
┌──────────────┬─────────────────────────────────────┐
│ 异常类型     │ 处理措施                            │
├──────────────┼─────────────────────────────────────┤
│ 延迟成交     │ 撤单重下 / 调整价格 / 继续等待      │
│ 部分成交     │ 撤单剩余部分 / 继续等待             │
│ 价格异常     │ 立即撤单，触发风控调查              │
│ 重复成交     │ 记录差异，人工介入                  │
│ API 错误     │ 重试 (最多 3 次) / 切换备用通道       │
└──────────────┴─────────────────────────────────────┘
```

### 5.3 执行质量分析

**核心指标**:

1. **执行滑点 (Slippage)**
   ```
   滑点 (bps) = (实际成交价 - 决策时市价) / 决策时市价 * 10000
   ```

2. **执行效率 (Fill Rate)**
   ```
   执行效率 = 实际成交数量 / 计划成交数量 * 100%
   ```

3. **市场冲击 (Market Impact)**
   ```
   市场冲击 = (执行后价格 - 执行前价格) / 执行前价格 * 100%
   ```

4. **时间加权执行价格 (TWAP Price)**
   ```
   TWAP 价格 = Σ(成交价 × 成交量) / Σ成交量
   ```

5. **执行成本 (Implementation Shortfall)**
   ```
   IS = (实际组合收益 - 纸上组合收益) / 纸上组合收益
   ```

**分析维度**:
- 按策略分析：哪个策略执行成本最高
- 按标的分析：哪个股票滑点最大
- 按时间段分析：哪个时段执行效果最好
- 按算法分析：TWAP vs VWAP 效果对比

### 5.4 监控仪表盘

**实时监控**:
- 当前待执行订单队列
- 正在执行的订单进度
- 今日累计成交量和成交额
- 实时滑点和执行成本

**日报内容**:
- 执行统计汇总
- 异常订单列表
- 执行质量排名 (按策略/标的)
- 改进建议

## 6. 数据流设计

### 6.1 核心数据结构

```python
@dataclass
class Signal:
    signal_id: str
    strategy_id: str
    symbol: str
    side: str  # BUY/SELL
    quantity: Decimal
    price_type: str  # MARKET/LIMIT/TWAP/VWAP
    limit_price: Optional[Decimal]
    priority: int
    timestamp: datetime
    expire_at: Optional[datetime]
    metadata: Dict[str, Any]

@dataclass
class Order:
    order_id: str
    signal_id: str
    symbol: str
    side: str
    quantity: Decimal
    filled_quantity: Decimal
    avg_price: Decimal
    status: str
    created_at: datetime
    updated_at: datetime
    execution_report: List[ExecutionReport]

@dataclass
class ExecutionReport:
    report_id: str
    order_id: str
    exec_id: str
    quantity: Decimal
    price: Decimal
    timestamp: datetime
    venue: str
    commission: Decimal
```

### 6.2 状态机

**订单状态流转**:
```
PENDING → [风控检查] → APPROVED → SUBMITTED → PARTIALLY_FILLED → FILLED
                              ↓                    ↓
                          REJECTED            CANCELLED
                              ↓                    ↓
                          FAILED               EXPIRED
```

## 7. 配置管理

### 7.1 系统配置

```yaml
trading:
  markets:
    - US  # 美股
    - CN  # A 股
  
  risk_limits:
    max_position_pct: 0.20      # 单标的最大仓位
    max_sector_pct: 0.40        # 单行业最大仓位
    max_total_position: 0.95    # 最大总仓位
    max_leverage: 2.0           # 最大杠杆
    max_daily_trades: 5         # 单日交易次数限制
    
  execution:
    default_algorithm: TWAP     # 默认拆单算法
    max_slice_pct: 0.05         # 单笔最大占日均成交量比例
    min_slice_interval: 30      # 最小下单间隔 (秒)
    price_tolerance: 0.005      # 价格偏离容忍度
    
  slippage:
    base_bps: 5                 # 基础滑点预算
    max_bps: 50                 # 最大滑点预算
    
  monitoring:
    report_interval: 60         # 执行报告间隔 (秒)
    alert_threshold_bps: 30     # 滑点告警阈值
```

### 7.2 环境配置

| 环境 | 交易模式 | 订单类型 | 风控级别 |
|------|----------|----------|----------|
| `BACKTEST` | 模拟 | 全部记录不执行 | 宽松 |
| `PAPER` | 模拟 | 发送到券商但标记为模拟 | 标准 |
| `LIVE` | 实盘 | 真实执行 | 严格 |

## 8. 异常处理与容灾

### 8.1 异常处理原则

1. **快速失败**: 检测到异常立即停止相关操作
2. **优雅降级**: 主通道失败自动切换到备用通道
3. **状态可恢复**: 所有状态持久化，支持断点续传
4. **完整审计**: 所有操作记录日志，支持追溯

### 8.2 容灾方案

| 故障场景 | 应对措施 |
|----------|----------|
| 券商 API 中断 | 切换到备用券商 / 暂停交易并告警 |
| 网络中断 | 本地缓存订单，网络恢复后重放 |
| 系统崩溃 | 从持久化状态恢复，继续执行 |
| 数据异常 | 停止交易，人工介入检查 |

### 8.3 紧急平仓机制

**触发条件**:
- 系统检测到重大风险 (如保证金不足)
- 人工触发紧急停止
- 市场异常波动 (如熔断)

**执行流程**:
1. 立即暂停所有新开仓信号
2. 计算需要平仓的头寸
3. 生成紧急平仓信号 (优先级最高)
4. 使用市价单快速平仓
5. 通知相关人员

## 9. 性能指标

### 9.1 延迟要求

| 环节 | 目标延迟 | 最大延迟 |
|------|----------|----------|
| 信号接收 → 验证 | < 1ms | < 5ms |
| 风控检查 | < 5ms | < 20ms |
| 订单生成 → 发送 | < 10ms | < 50ms |
| 成交回报处理 | < 10ms | < 100ms |
| **端到端延迟** | **< 50ms** | **< 200ms** |

### 9.2 吞吐量要求

- 信号处理能力：≥ 1000 信号/秒
- 订单处理能力：≥ 500 订单/秒
- 成交回报处理：≥ 2000 回报/秒

### 9.3 可用性要求

- 系统可用性：≥ 99.9%
- 数据持久化：100%
- 订单不丢失：100%

## 10. 安全与合规

### 10.1 安全措施

- **API 密钥管理**: 加密存储，定期轮换
- **访问控制**: 基于角色的权限管理
- **操作审计**: 所有操作记录日志
- **数据加密**: 敏感数据加密传输和存储

### 10.2 合规要求

- **美股**: 遵守 SEC 规则，PDT 限制，Report 要求
- **A 股**: 遵守 T+1 交易规则，涨跌停限制
- **反洗钱**: 大额交易报告，可疑交易监控

## 11. 扩展性设计

### 11.1 插件化架构

- **执行算法插件**: 支持自定义拆单算法
- **风控规则插件**: 支持自定义风控规则
- **券商适配器**: 支持快速接入新券商

### 11.2 未来扩展

- 支持更多市场 (港股、期货、加密货币)
- 支持更多订单类型 (冰山订单、隐藏订单)
- 支持机器学习优化执行策略

---

## 附录 A: 交易执行流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        交易执行完整流程                              │
└─────────────────────────────────────────────────────────────────────┘

策略层          信号管理          风控检查          订单执行          执行监控
  │                │                 │                 │                 │
  │  生成信号      │                 │                 │                 │
  │───────────────▶│                 │                 │                 │
  │                │ 接收并验证信号  │                 │                 │
  │                │ 优先级排序      │                 │                 │
  │                │ 去重合并        │                 │                 │
  │                │                 │                 │                 │
  │                │ 待执行信号      │                 │                 │
  │                │────────────────▶│                 │                 │
  │                │                 │ 前置风控检查    │                 │
  │                │                 │ 仓位限制验证    │                 │
  │                │                 │ 黑名单检查      │                 │
  │                │                 │                 │                 │
  │                │                 │ ✅ 通过         │                 │
  │                │                 │────────────────▶│                 │
  │                │                 │                 │ 智能订单路由    │
  │                │                 │                 │ 拆单算法        │
  │                │                 │                 │ 滑点控制        │
  │                │                 │                 │                 │
  │                │                 │                 │ 发送订单        │
  │                │                 │                 │────────────────▶│
  │                │                 │                 │                 │ 监控执行
  │                │                 │                 │                 │ 处理回报
  │                │                 │                 │                 │ 质量分析
  │                │                 │                 │                 │
  │                │◀────────────────────────────────────────────────────│
  │  执行结果通知  │                 │                 │                 │
  │◀───────────────│                 │                 │                 │
  │                │                 │                 │                 │
```

## 附录 B: 关键设计决策

### 决策 1: 信号优先级队列 vs FIFO

**选择**: 优先级队列

**理由**:
- 风控信号 (止损/紧急平仓) 必须优先于策略信号
- 避免重要信号被大量普通信号阻塞
- 实现简单，Python heapq 原生支持

### 决策 2: TWAP vs VWAP 作为默认算法

**选择**: TWAP 作为默认，VWAP 作为可选

**理由**:
- TWAP 实现简单，参数少，易于调试
- VWAP 需要历史成交量数据，对数据质量要求高
- 对于小单，两者差异不大
- 大单可根据标的流动性选择 VWAP

### 决策 3: 同步 vs 异步风控检查

**选择**: 同步检查

**理由**:
- 风控是交易的前置条件，必须 blocking
- 检查逻辑简单，延迟可控 (< 20ms)
- 避免风控检查与订单执行并发导致的状态不一致

### 决策 4: 内存 vs 持久化存储

**选择**: 混合模式

**理由**:
- 待执行队列：内存 (Redis) + 定期快照
- 已完成订单：持久化 (PostgreSQL)
- 执行报告：持久化 + 实时流式处理
- 平衡性能和可靠性

### 决策 5: 单体 vs 微服务

**选择**: 模块化单体 (初期)

**理由**:
- 降低系统复杂度
- 减少网络延迟
- 便于调试和监控
- 未来可按模块拆分为微服务

---

**文档版本**: v1.0  
**创建日期**: 2026-03-01  
**作者**: Trader (Q 脑交易执行员)  
**审核状态**: 待审核
