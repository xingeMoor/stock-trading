"""
å¤šç­–ç•¥æ¡†æ¶
æ ¹æ®å¸‚åœºçŠ¶æ€å’Œè‚¡ç¥¨ç‰¹æ€§è‡ªåŠ¨é€‰æ‹©æœ€ä½³ç­–ç•¥
"""
from typing import Dict, Any, Tuple, Callable
from datetime import datetime


# ============================================================================
# ç­–ç•¥ 1: è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥ (Trend Following)
# é€‚ç”¨ï¼šå•è¾¹ä¸Šæ¶¨è¶‹åŠ¿è‚¡ç¥¨ (å¦‚ GOOGL)
# ============================================================================
def trend_following_strategy(row, indicators: Dict[str, Any]) -> str:
    """
    è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥
    
    æ ¸å¿ƒé€»è¾‘:
    - åªåœ¨æ˜ç¡®ä¸Šå‡è¶‹åŠ¿ä¸­åšå¤š (SMA50 > SMA200 > Price)
    - RSI é€‚ä¸­æ—¶ä¹°å…¥ (30-60)
    - è¶‹åŠ¿åè½¬æ—¶å–å‡º
    
    é€‚ç”¨åœºæ™¯ï¼šGOOGL ç±»å•è¾¹ä¸Šæ¶¨è‚¡ç¥¨
    """
    buy_conditions = []
    sell_conditions = []
    
    # è·å–æŒ‡æ ‡
    price = indicators.get('current_price', row.get('close', 0))
    sma_20 = indicators.get('sma_20')
    sma_50 = indicators.get('sma_50')
    sma_200 = indicators.get('sma_200')
    rsi = indicators.get('rsi_14')
    macd = indicators.get('macd')
    macd_signal = indicators.get('macd_signal')
    
    # === ä¸¥æ ¼è¶‹åŠ¿è¿‡æ»¤ ===
    # åªåœ¨åšå¤šæ¡ä»¶ï¼šSMA50 > SMA200 ä¸” ä»·æ ¼ > SMA50
    strong_uptrend = (sma_50 and sma_200 and 
                      sma_50 > sma_200 and 
                      price > sma_50)
    
    # === ä¹°å…¥æ¡ä»¶ ===
    if strong_uptrend:
        # RSI é€‚ä¸­ (30-65) - æ”¾å®½
        if rsi and 30 <= rsi <= 65:
            buy_conditions.append(f"RSI é€‚ä¸­ ({rsi:.1f})")
        
        # MACD é‡‘å‰æˆ–ä¸ºæ­£
        if macd and macd_signal:
            if macd > macd_signal:
                buy_conditions.append("MACD é‡‘å‰")
            elif macd > 0:
                buy_conditions.append("MACD ä¸ºæ­£")
        
        # ä»·æ ¼åœ¨ SMA20 ä¹‹ä¸Š
        if sma_20 and price > sma_20:
            buy_conditions.append("ä»·æ ¼>SMA20")
    
    # === å–å‡ºæ¡ä»¶ ===
    # è¶‹åŠ¿åè½¬
    if sma_50 and sma_200 and sma_50 < sma_200:
        sell_conditions.append("è¶‹åŠ¿åè½¬ (SMA50 < SMA200)")
    
    # ä»·æ ¼è·Œç ´ SMA50
    if sma_50 and price < sma_50:
        sell_conditions.append("ä»·æ ¼è·Œç ´ SMA50")
    
    # RSI è¶…ä¹°
    if rsi and rsi > 70:
        sell_conditions.append(f"RSI è¶…ä¹° ({rsi:.1f})")
    
    # MACD æ­»å‰
    if macd and macd_signal and macd < macd_signal:
        sell_conditions.append("MACD æ­»å‰")
    
    # å†³ç­–
    if len(buy_conditions) >= 1:
        return 'buy'
    elif len(sell_conditions) >= 1:
        return 'sell'
    else:
        return 'hold'


# ============================================================================
# ç­–ç•¥ 2: å‡å€¼å›å½’ç­–ç•¥ (Mean Reversion)
# é€‚ç”¨ï¼šéœ‡è¡å¸‚è‚¡ç¥¨ (å¦‚ META, AMZN)
# ============================================================================
def mean_reversion_strategy(row, indicators: Dict[str, Any]) -> str:
    """
    å‡å€¼å›å½’ç­–ç•¥
    
    æ ¸å¿ƒé€»è¾‘:
    - åœ¨éœ‡è¡å¸‚ä¸­ä½ä¹°é«˜å–
    - RSI è¶…å–ä¹°å…¥ï¼Œè¶…ä¹°å–å‡º
    - å¸ƒæ—å¸¦è¾¹ç•Œä½œä¸ºå‚è€ƒ
    
    é€‚ç”¨åœºæ™¯ï¼šMETA/AMZN ç±»éœ‡è¡è‚¡ç¥¨
    """
    buy_conditions = []
    sell_conditions = []
    
    # è·å–æŒ‡æ ‡
    price = indicators.get('current_price', row.get('close', 0))
    sma_20 = indicators.get('sma_20')
    rsi = indicators.get('rsi_14')
    stoch_k = indicators.get('stoch_k')
    stoch_d = indicators.get('stoch_d')
    bb_upper = indicators.get('bb_upper')
    bb_lower = indicators.get('bb_lower')
    
    # === éœ‡è¡å¸‚åˆ¤æ–­ ===
    # SMA çº ç¼  (SMA20/SMA50 æ¥è¿‘)
    is_ranging = True  # ç®€åŒ–å‡è®¾
    
    if is_ranging:
        # === ä¹°å…¥æ¡ä»¶ (è¶…å–) ===
        # RSI è¶…å– (<30)
        if rsi and rsi < 30:
            buy_conditions.append(f"RSI è¶…å– ({rsi:.1f})")
        
        # éšæœºæŒ‡æ ‡è¶…å–
        if stoch_k and stoch_d and stoch_k < 20 and stoch_k > stoch_d:
            buy_conditions.append("éšæœºæŒ‡æ ‡è¶…å–é‡‘å‰")
        
        # ä»·æ ¼è§¦åŠå¸ƒæ—å¸¦ä¸‹è½¨
        if bb_lower and price <= bb_lower * 1.01:
            buy_conditions.append("ä»·æ ¼è§¦åŠå¸ƒæ—å¸¦ä¸‹è½¨")
        
        # === å–å‡ºæ¡ä»¶ (è¶…ä¹°) ===
        # RSI è¶…ä¹° (>70)
        if rsi and rsi > 70:
            sell_conditions.append(f"RSI è¶…ä¹° ({rsi:.1f})")
        
        # éšæœºæŒ‡æ ‡è¶…ä¹°
        if stoch_k and stoch_d and stoch_k > 80 and stoch_k < stoch_d:
            sell_conditions.append("éšæœºæŒ‡æ ‡è¶…ä¹°æ­»å‰")
        
        # ä»·æ ¼è§¦åŠå¸ƒæ—å¸¦ä¸Šè½¨
        if bb_upper and price >= bb_upper * 0.99:
            sell_conditions.append("ä»·æ ¼è§¦åŠå¸ƒæ—å¸¦ä¸Šè½¨")
    
    # å†³ç­–
    if len(buy_conditions) >= 1:
        return 'buy'
    elif len(sell_conditions) >= 1:
        return 'sell'
    else:
        return 'hold'


# ============================================================================
# ç­–ç•¥ 3: çªç ´ç­–ç•¥ (Breakout)
# é€‚ç”¨ï¼šé«˜æ³¢åŠ¨æˆé•¿è‚¡ (å¦‚ AMD, NVDA, INTC)
# ============================================================================
def breakout_strategy(row, indicators: Dict[str, Any]) -> str:
    """
    çªç ´ç­–ç•¥
    
    æ ¸å¿ƒé€»è¾‘:
    - çªç ´å…³é”®é˜»åŠ›ä½æ—¶ä¹°å…¥
    - æˆäº¤é‡æ”¾å¤§ç¡®è®¤çªç ´
    - å¿«é€Ÿæ­¢æŸ
    
    é€‚ç”¨åœºæ™¯ï¼šAMD/NVDA/INTC ç±»é«˜æ³¢åŠ¨è‚¡ç¥¨
    """
    buy_conditions = []
    sell_conditions = []
    
    # è·å–æŒ‡æ ‡
    price = indicators.get('current_price', row.get('close', 0))
    volume = indicators.get('volume', 0)
    avg_volume = indicators.get('avg_volume_20', 0)
    resistance = indicators.get('resistance_level')
    support = indicators.get('support_level')
    atr = indicators.get('atr_14')
    rsi = indicators.get('rsi_14')
    
    # === ä¹°å…¥æ¡ä»¶ (çªç ´) ===
    # ä»·æ ¼çªç ´é˜»åŠ›ä½
    if resistance and price > resistance * 1.02:
        buy_conditions.append(f"çªç ´é˜»åŠ›ä½ ${resistance:.2f}")
        
        # æˆäº¤é‡æ”¾å¤§ç¡®è®¤
        if avg_volume and volume > avg_volume * 1.5:
            buy_conditions.append("æˆäº¤é‡æ”¾å¤§ç¡®è®¤çªç ´")
    
    # åˆ› N æ—¥æ–°é«˜
    high_52w = indicators.get('high_52w')
    if high_52w and price > high_52w * 0.98:
        buy_conditions.append("æ¥è¿‘ 52 å‘¨æ–°é«˜")
    
    # === å–å‡ºæ¡ä»¶ ===
    # è·Œç ´æ”¯æ’‘ä½
    if support and price < support * 0.98:
        sell_conditions.append(f"è·Œç ´æ”¯æ’‘ä½ ${support:.2f}")
    
    # å‡çªç ´ (çªç ´åå¿«é€Ÿå›è½)
    if len(buy_conditions) > 0 and rsi and rsi < 40:
        sell_conditions.append("çªç ´å¤±è´¥ï¼Œå¿«é€Ÿå›è½")
    
    # å†³ç­–
    if len(buy_conditions) >= 1:
        return 'buy'
    elif len(sell_conditions) >= 1:
        return 'sell'
    else:
        return 'hold'


# ============================================================================
# ç­–ç•¥ 4: é˜²å®ˆç­–ç•¥ (Defensive)
# é€‚ç”¨ï¼šä¸‹è·Œè¶‹åŠ¿è‚¡ç¥¨ (å¦‚ NFLX, MSFT åœ¨ç†Šå¸‚)
# ============================================================================
def defensive_strategy(row, indicators: Dict[str, Any]) -> str:
    """
    é˜²å®ˆç­–ç•¥
    
    æ ¸å¿ƒé€»è¾‘:
    - ä¸‹è·Œè¶‹åŠ¿ä¸­ä¿æŒç©ºä»“
    - åªåœ¨å¼ºåŠ›åå¼¹æ—¶çŸ­çº¿å‚ä¸
    - ä¸¥æ ¼æ­¢æŸ
    
    é€‚ç”¨åœºæ™¯ï¼šNFLX/MSFT ç±»ä¸‹è·Œè¶‹åŠ¿è‚¡ç¥¨
    """
    buy_conditions = []
    sell_conditions = []
    
    # è·å–æŒ‡æ ‡
    price = indicators.get('current_price', row.get('close', 0))
    sma_50 = indicators.get('sma_50')
    sma_200 = indicators.get('sma_200')
    rsi = indicators.get('rsi_14')
    
    # === ä¸‹è·Œè¶‹åŠ¿åˆ¤æ–­ ===
    sma_20 = indicators.get('sma_20')
    downtrend = (sma_50 and sma_200 and 
                 sma_50 < sma_200 and 
                 price < sma_50)
    
    if downtrend:
        # === åªåœ¨è¶…å–æ—¶çŸ­çº¿ä¹°å…¥ ===
        # RSI æåº¦è¶…å– (<25)
        if rsi and rsi < 25:
            buy_conditions.append(f"æåº¦è¶…å– (RSI={rsi:.1f})ï¼ŒçŸ­çº¿åå¼¹")
        
        # === å¿«é€Ÿå–å‡º ===
        # åå¼¹åˆ°é˜»åŠ›ä½
        if sma_20 and price > sma_20:
            sell_conditions.append("åå¼¹åˆ° SMA20ï¼Œè·åˆ©äº†ç»“")
        
        # RSI å›åˆ°ä¸­æ€§
        if rsi and rsi > 50:
            sell_conditions.append("RSI å›åˆ°ä¸­æ€§ï¼Œé€€å‡º")
        
        # è¶‹åŠ¿ç»§ç»­å‘ä¸‹
        if sma_50 and price < sma_50 * 0.98:
            sell_conditions.append("è¶‹åŠ¿ç»§ç»­å‘ä¸‹ï¼Œç©ºä»“è§‚æœ›")
    else:
        # ä¸æ˜¯ä¸‹è·Œè¶‹åŠ¿ï¼Œè¿”å› HOLD
        return 'hold'
    
    # å†³ç­– (é˜²å®ˆç­–ç•¥é»˜è®¤ HOLDï¼Œåªåœ¨æç«¯æƒ…å†µè¡ŒåŠ¨)
    if len(buy_conditions) >= 1:
        return 'buy'  # çŸ­çº¿å‚ä¸
    elif len(sell_conditions) >= 1:
        return 'sell'
    else:
        return 'hold'  # é»˜è®¤ç©ºä»“è§‚æœ›


# ============================================================================
# å¸‚åœºçŠ¶æ€è¯†åˆ«
# ============================================================================
def identify_market_regime(indicators: Dict[str, Any]) -> str:
    """
    è¯†åˆ«å¸‚åœºçŠ¶æ€
    
    è¿”å›:
    - 'BULL_MARK': ç‰›å¸‚ (å•è¾¹ä¸Šæ¶¨)
    - 'BEAR_MARK': ç†Šå¸‚ (å•è¾¹ä¸‹è·Œ)
    - 'RANGING': éœ‡è¡å¸‚
    - 'VOLATILE': é«˜æ³¢åŠ¨
    """
    price = indicators.get('current_price', 0)
    sma_50 = indicators.get('sma_50', 0)
    sma_200 = indicators.get('sma_200', 0)
    atr = indicators.get('atr_14', 0)
    rsi = indicators.get('rsi_14', 50)
    
    # è®¡ç®—æ³¢åŠ¨ç‡
    volatility = atr / price if price > 0 and atr else 0.02
    
    # åˆ¤æ–­è¶‹åŠ¿
    if sma_50 and sma_200:
        if sma_50 > sma_200 and price > sma_50:
            if volatility < 0.03:
                return 'BULL_MARK'  # ç¨³å®šä¸Šæ¶¨
            else:
                return 'VOLATILE_BULL'  # é«˜æ³¢åŠ¨ä¸Šæ¶¨
        elif sma_50 < sma_200 and price < sma_50:
            return 'BEAR_MARK'  # ä¸‹è·Œè¶‹åŠ¿
        else:
            return 'RANGING'  # SMA çº ç¼ ï¼Œéœ‡è¡å¸‚
    else:
        return 'RANGING'


# ============================================================================
# è‚¡ç¥¨ç‰¹æ€§åˆ†ç±»
# ============================================================================
def classify_stock_characteristics(symbol: str, historical_data: Dict[str, Any]) -> str:
    """
    åˆ†ç±»è‚¡ç¥¨ç‰¹æ€§
    
    åŸºäºå†å²è¡¨ç°åˆ†ç±»:
    - 'TRENDING': è¶‹åŠ¿å‹ (GOOGL)
    - 'RANGING': éœ‡è¡å‹ (META, AMZN)
    - 'VOLATILE': é«˜æ³¢åŠ¨å‹ (AMD, NVDA, INTC)
    - 'DECLINING': ä¸‹è·Œå‹ (NFLX, MSFT åœ¨ç‰¹å®šæ—¶æœŸ)
    """
    # ç®€åŒ–å®ç° (å®é™…åº”åŸºäºå†å²æ•°æ®è®¡ç®—)
    stock_profiles = {
        'GOOGL': 'TRENDING',
        'AAPL': 'TRENDING',
        'META': 'RANGING',
        'AMZN': 'RANGING',
        'NVDA': 'VOLATILE',
        'AMD': 'VOLATILE',
        'INTC': 'VOLATILE',
        'TSLA': 'VOLATILE',
        'MSFT': 'TRENDING',
        'NFLX': 'DECLINING'
    }
    
    return stock_profiles.get(symbol.upper(), 'RANGING')


# ============================================================================
# å¤šç­–ç•¥åè°ƒå™¨
# ============================================================================
class MultiStrategyCoordinator:
    """
    å¤šç­–ç•¥åè°ƒå™¨
    æ ¹æ®å¸‚åœºçŠ¶æ€å’Œè‚¡ç¥¨ç‰¹æ€§è‡ªåŠ¨é€‰æ‹©æœ€ä½³ç­–ç•¥
    """
    
    def __init__(self):
        self.strategies = {
            'trend_following': trend_following_strategy,
            'mean_reversion': mean_reversion_strategy,
            'breakout': breakout_strategy,
            'defensive': defensive_strategy
        }
    
    def select_strategy(self, symbol: str, 
                       market_regime: str,
                       stock_type: str) -> Tuple[str, Callable]:
        """
        é€‰æ‹©æœ€ä½³ç­–ç•¥
        
        è¿”å›ï¼š(ç­–ç•¥åç§°ï¼Œç­–ç•¥å‡½æ•°)
        """
        # ç­–ç•¥é€‰æ‹©çŸ©é˜µ
        strategy_matrix = {
            ('BULL_MARK', 'TRENDING'): 'trend_following',
            ('BULL_MARK', 'VOLATILE'): 'breakout',
            ('RANGING', 'RANGING'): 'mean_reversion',
            ('RANGING', 'TRENDING'): 'trend_following',
            ('BEAR_MARK', 'DECLINING'): 'defensive',
            ('BEAR_MARK', 'TRENDING'): 'defensive',
            ('VOLATILE_BULL', 'VOLATILE'): 'breakout',
        }
        
        key = (market_regime, stock_type)
        strategy_name = strategy_matrix.get(key, 'trend_following')
        
        return strategy_name, self.strategies[strategy_name]
    
    def execute(self, symbol: str, row, 
                indicators: Dict[str, Any],
                historical_data: Dict[str, Any] = None) -> Dict[str, Any]:
        """
        æ‰§è¡Œå¤šç­–ç•¥å†³ç­–
        
        è¿”å›ï¼š{
            'action': 'buy/sell/hold',
            'strategy_used': 'ç­–ç•¥åç§°',
            'market_regime': 'å¸‚åœºçŠ¶æ€',
            'stock_type': 'è‚¡ç¥¨ç±»å‹',
            'confidence': ç½®ä¿¡åº¦,
            'reasoning': 'ç†ç”±'
        }
        """
        # 1. è¯†åˆ«å¸‚åœºçŠ¶æ€
        market_regime = identify_market_regime(indicators)
        
        # 2. åˆ†ç±»è‚¡ç¥¨ç‰¹æ€§
        stock_type = classify_stock_characteristics(symbol, historical_data or {})
        
        # 3. é€‰æ‹©ç­–ç•¥
        strategy_name, strategy_func = self.select_strategy(
            symbol, market_regime, stock_type
        )
        
        # 4. æ‰§è¡Œç­–ç•¥
        action = strategy_func(row, indicators)
        
        # 5. è®¡ç®—ç½®ä¿¡åº¦
        confidence = self._calculate_confidence(
            market_regime, stock_type, strategy_name
        )
        
        # 6. ç”Ÿæˆç†ç”±
        reasoning = self._generate_reasoning(
            symbol, market_regime, stock_type, strategy_name, action
        )
        
        return {
            'action': action,
            'strategy_used': strategy_name,
            'market_regime': market_regime,
            'stock_type': stock_type,
            'confidence': confidence,
            'reasoning': reasoning,
            'timestamp': datetime.now().isoformat()
        }
    
    def _calculate_confidence(self, market_regime: str, 
                             stock_type: str,
                             strategy_name: str) -> float:
        """è®¡ç®—ç½®ä¿¡åº¦"""
        # ç­–ç•¥åŒ¹é…åº¦é«˜åˆ™ç½®ä¿¡åº¦é«˜
        perfect_matches = [
            ('BULL_MARK', 'TRENDING', 'trend_following'),
            ('RANGING', 'RANGING', 'mean_reversion'),
            ('VOLATILE_BULL', 'VOLATILE', 'breakout')
        ]
        
        if (market_regime, stock_type, strategy_name) in perfect_matches:
            return 0.8
        else:
            return 0.6
    
    def _generate_reasoning(self, symbol: str, market_regime: str,
                           stock_type: str, strategy_name: str,
                           action: str) -> str:
        """ç”Ÿæˆç†ç”±"""
        regime_desc = {
            'BULL_MARK': 'ç‰›å¸‚ä¸Šæ¶¨è¶‹åŠ¿',
            'BEAR_MARK': 'ç†Šå¸‚ä¸‹è·Œè¶‹åŠ¿',
            'RANGING': 'éœ‡è¡å¸‚',
            'VOLATILE_BULL': 'é«˜æ³¢åŠ¨ä¸Šæ¶¨'
        }
        
        stock_desc = {
            'TRENDING': 'è¶‹åŠ¿å‹è‚¡ç¥¨',
            'RANGING': 'éœ‡è¡å‹è‚¡ç¥¨',
            'VOLATILE': 'é«˜æ³¢åŠ¨è‚¡ç¥¨',
            'DECLINING': 'ä¸‹è·Œè¶‹åŠ¿è‚¡ç¥¨'
        }
        
        strategy_desc = {
            'trend_following': 'è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥',
            'mean_reversion': 'å‡å€¼å›å½’ç­–ç•¥',
            'breakout': 'çªç ´ç­–ç•¥',
            'defensive': 'é˜²å®ˆç­–ç•¥'
        }
        
        return (f"{symbol}: {regime_desc.get(market_regime, 'æœªçŸ¥å¸‚åœº')} + "
                f"{stock_desc.get(stock_type, 'æœªçŸ¥ç±»å‹')} â†’ "
                f"ä½¿ç”¨{strategy_desc.get(strategy_name, 'æœªçŸ¥ç­–ç•¥')} â†’ "
                f"å†³ç­–ï¼š{action.upper()}")


# ============================================================================
# ä½¿ç”¨ç¤ºä¾‹
# ============================================================================
if __name__ == "__main__":
    print("="*60)
    print("ğŸ¯ å¤šç­–ç•¥æ¡†æ¶ - æµ‹è¯•")
    print("="*60)
    
    coordinator = MultiStrategyCoordinator()
    
    # æµ‹è¯•ä¸åŒè‚¡ç¥¨
    test_cases = [
        ('GOOGL', {
            'current_price': 175.0,
            'sma_20': 170.0,
            'sma_50': 165.0,
            'sma_200': 155.0,
            'rsi_14': 45.0,
            'macd': 2.5,
            'macd_signal': 1.8,
            'atr_14': 3.5
        }),
        ('META', {
            'current_price': 500.0,
            'sma_20': 495.0,
            'sma_50': 505.0,
            'sma_200': 500.0,
            'rsi_14': 65.0,
            'stoch_k': 75.0,
            'stoch_d': 70.0
        }),
        ('AMD', {
            'current_price': 180.0,
            'sma_20': 175.0,
            'sma_50': 170.0,
            'sma_200': 160.0,
            'rsi_14': 55.0,
            'volume': 100000000,
            'avg_volume_20': 60000000,
            'resistance_level': 175.0,
            'atr_14': 8.0
        }),
        ('NFLX', {
            'current_price': 450.0,
            'sma_20': 470.0,
            'sma_50': 490.0,
            'sma_200': 520.0,
            'rsi_14': 35.0,
            'atr_14': 15.0
        })
    ]
    
    class MockRow:
        def __init__(self, close):
            self.close = close
        def get(self, key, default=None):
            return getattr(self, key, default)
    
    for symbol, indicators in test_cases:
        print(f"\nã€{symbol}ã€‘æµ‹è¯•:")
        
        result = coordinator.execute(
            symbol=symbol,
            row=MockRow(indicators['current_price']),
            indicators=indicators
        )
        
        print(f"  å¸‚åœºçŠ¶æ€ï¼š{result['market_regime']}")
        print(f"  è‚¡ç¥¨ç±»å‹ï¼š{result['stock_type']}")
        print(f"  ä½¿ç”¨ç­–ç•¥ï¼š{result['strategy_used']}")
        print(f"  å†³ç­–ï¼š{result['action'].upper()}")
        print(f"  ç½®ä¿¡åº¦ï¼š{result['confidence']:.1%}")
        print(f"  ç†ç”±ï¼š{result['reasoning']}")
    
    print(f"\n{'='*60}")
    print("âœ… å¤šç­–ç•¥æ¡†æ¶æµ‹è¯•å®Œæˆï¼")
