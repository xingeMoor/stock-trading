# Q脑系统架构设计文档

## 1. 整体系统架构

### 1.1 架构分层设计

```
┌─────────────────────────────────────────────────────────────────┐
│                        监控层 (Monitor Layer)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  Dashboard  │  │   Alert     │  │   Report    │              │
│  │   Agent     │  │   Agent     │  │   Agent     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              ↕ (事件/指标)
┌─────────────────────────────────────────────────────────────────┐
│                        执行层 (Execution Layer)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Order     │  │  Position   │  │   Risk      │              │
│  │   Agent     │  │   Agent     │  │   Agent     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              ↕ (信号/指令)
┌─────────────────────────────────────────────────────────────────┐
│                        策略层 (Strategy Layer)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  Strategy   │  │  Backtest   │  │  Signal     │              │
│  │   Agent     │  │   Agent     │  │   Agent     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              ↕ (数据/特征)
┌─────────────────────────────────────────────────────────────────┐
│                         数据层 (Data Layer)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Market    │  │   Fund      │  │   Alt       │              │
│  │   Data      │  │   Data      │  │   Data      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心组件说明

#### 数据层 (Data Layer)
- **职责**: 数据采集、清洗、存储、分发
- **组件**:
  - `MarketDataCollector`: 实时/历史行情采集
  - `FundamentalDataLoader`: 财务数据、基本面数据
  - `AlternativeDataSource`: 舆情、新闻、社交媒体数据
  - `DataValidator`: 数据质量校验
  - `DataCache`: 多级缓存管理

#### 策略层 (Strategy Layer)
- **职责**: 策略研发、回测、信号生成
- **组件**:
  - `StrategyEngine`: 策略生命周期管理
  - `BacktestEngine`: 历史回测引擎
  - `SignalGenerator`: 交易信号生成
  - `FactorLibrary`: 因子库管理
  - `PortfolioOptimizer`: 组合优化

#### 执行层 (Execution Layer)
- **职责**: 订单执行、仓位管理、风险控制
- **组件**:
  - `OrderManager`: 订单生命周期管理
  - `ExecutionEngine`: 智能订单执行
  - `PositionTracker`: 实时仓位跟踪
  - `RiskController`: 实时风险监控
  - `BrokerConnector`: 券商接口适配

#### 监控层 (Monitor Layer)
- **职责**: 系统监控、告警、报告
- **组件**:
  - `SystemMonitor`: 系统健康度监控
  - `PerformanceAnalyzer`: 绩效分析
  - `AlertManager`: 告警管理
  - `ReportGenerator`: 报告生成
  - `Dashboard`: 可视化面板

### 1.3 Agent 通信机制

```
┌──────────────────────────────────────────────────────────────────┐
│                      Message Bus (Redis Pub/Sub)                  │
│                                                                   │
│  Topic: qbrain.data.*      → 数据更新事件                          │
│  Topic: qbrain.signal.*    → 交易信号事件                          │
│  Topic: qbrain.order.*     → 订单状态事件                          │
│  Topic: qbrain.risk.*      → 风险告警事件                          │
│  Topic: qbrain.system.*    → 系统事件                             │
└──────────────────────────────────────────────────────────────────┘
         ↕                    ↕                    ↕
    ┌─────────┐          ┌─────────┐          ┌─────────┐
    │  Data   │          │Strategy │          │Execution│
    │  Agent  │          │ Agent   │          │ Agent   │
    └─────────┘          └─────────┘          └─────────┘
```

**通信协议**:
- 采用 **发布/订阅模式** (Pub/Sub)
- 消息格式：统一 JSON Schema
- 消息持久化：关键事件写入事件日志表
- 重试机制：失败消息进入死信队列

**消息格式示例**:
```json
{
  "event_id": "uuid",
  "event_type": "signal.generated",
  "timestamp": 1709280000000,
  "source": "strategy_agent_001",
  "payload": {
    "strategy_id": "ma_cross_001",
    "symbol": "AAPL",
    "action": "BUY",
    "quantity": 100,
    "price": 185.50,
    "confidence": 0.85
  },
  "metadata": {
    "correlation_id": "corr_123",
    "priority": "high"
  }
}
```

### 1.4 数据流转设计

```
外部数据源 → 数据采集 → 数据清洗 → 数据存储 → 数据缓存
                                        ↓
                                    策略计算
                                        ↓
                                    信号生成 → 信号验证 → 订单生成
                                                      ↓
                                                订单执行 → 成交回报
                                                      ↓
                                                仓位更新 → 绩效计算
                                                      ↓
                                                监控告警 → 报告生成
```

**数据流关键节点**:

1. **数据采集流**:
   - 实时行情：WebSocket → Kafka → 实时数据库
   - 历史数据：API 批量拉取 → 清洗 → 时序数据库
   - 基本面数据：定时任务 → 关系型数据库

2. **策略计算流**:
   - 触发方式：定时/事件驱动
   - 输入：特征数据 + 参数配置
   - 输出：交易信号 (带置信度)

3. **交易执行流**:
   - 信号接收 → 风控检查 → 订单生成 → 路由执行 → 状态跟踪

4. **监控反馈流**:
   - 实时指标采集 → 阈值判断 → 告警触发 → 通知发送

---

## 2. 部署架构

### 2.1 开发环境
```
┌─────────────────────────────────────┐
│         开发者本地环境               │
│  ┌───────────┐  ┌───────────────┐   │
│  │   Q脑     │  │   本地服务     │   │
│  │   CLI     │  │ (SQLite+Redis)│   │
│  └───────────┘  └───────────────┘   │
└─────────────────────────────────────┘
```

### 2.2 生产环境
```
┌─────────────────────────────────────────────────────────────┐
│                      Kubernetes Cluster                      │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   Data      │  │  Strategy   │  │  Execution  │          │
│  │   Pods      │  │   Pods      │  │   Pods      │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │    Redis    │  │  PostgreSQL │  │   InfluxDB  │          │
│  │   Cluster   │  │   Cluster   │  │   Cluster   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Message Queue (Kafka)                   │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 安全架构

### 3.1 认证授权
- API 访问：JWT Token + API Key 双重认证
- 服务间通信：mTLS + Service Account
- 敏感操作：二次确认 + 审计日志

### 3.2 数据安全
- 传输加密：TLS 1.3
- 存储加密：AES-256
- 密钥管理：Vault/HSM

### 3.3 风控安全
- 订单限额：单笔/单日/总仓位限制
- 异常检测：熔断机制 + 人工确认
- 灾备方案：多活部署 + 数据备份

---

## 4. 扩展性设计

### 4.1 水平扩展
- 无状态服务：支持自动扩缩容
- 数据分片：按标的/时间分片
- 读写分离：主从复制 + 读写分离

### 4.2 策略扩展
- 插件化架构：策略热插拔
- 沙箱环境：策略隔离运行
- 版本管理：策略版本控制

### 4.3 市场扩展
- 多市场适配：统一接口抽象
- 时区处理：UTC 存储 + 本地展示
- 币种处理：多币种账户管理

---

## 5. 容灾设计

### 5.1 故障检测
- 健康检查：HTTP + TCP + 自定义
- 心跳机制：服务间定期心跳
- 超时控制：分级超时策略

### 5.2 故障恢复
- 自动重启：K8s 自动重启失败 Pod
- 故障转移：主备切换 < 30s
- 数据恢复：WAL 日志 + 备份恢复

### 5.3 降级策略
- 功能降级：核心功能优先
- 数据降级：使用缓存/历史数据
- 手动接管：紧急情况下人工干预

---

*文档版本：v1.0*
*最后更新：2026-03-01*
*作者：Archie (架构师)*
